# RKE2 Kubernetes Cluster Deployment

This project automates the deployment of a highly available RKE2 Kubernetes cluster on Proxmox using Terraform for infrastructure provisioning and Ansible for cluster configuration.

## Features

- **High Availability**: 3 control plane nodes with etcd clustering
- **Load Balancing**: Kube-VIP for API server load balancing
- **Service Load Balancing**: MetalLB for LoadBalancer services
- **Automated Deployment**: One-command deployment with `deploy.sh`
- **Infrastructure as Code**: Terraform manages VM lifecycle
- **Configuration Management**: Ansible handles RKE2 installation and configuration

## Architecture

### Infrastructure Components

- **Control Plane Nodes (Servers)**: 3 RKE2 server nodes for HA control plane
- **Worker Nodes (Agents)**: 2+ RKE2 agent nodes for workload execution
- **Virtual IP**: Kube-VIP provides a floating IP for API server access
- **Load Balancer Pool**: MetalLB manages LoadBalancer service IPs

### Network Configuration

- Control Plane VIP: Configured via `rke2_config.vip`
- MetalLB IP Range: Configured via `rke2_config.lb_range`
- Node Network: Static IPs assigned by Terraform

## Prerequisites

1. **Proxmox Environment**:

   - Proxmox VE cluster with API access
   - VM template with cloud-init support (Ubuntu recommended)
   - Network bridge configuration
   - Sufficient resources for cluster nodes

2. **Local Tools**:
   - Terraform >= 1.0
   - Ansible >= 2.9
   - SSH key pair for VM access

## Quick Start

1. **Clone and Configure**:

   ```bash
   git clone <repository>
   cd infraflux
   cp terraform.tfvars.example terraform.tfvars
   # Edit terraform.tfvars with your Proxmox details
   ```

2. **Deploy Complete Cluster**:

   ```bash
   ./deploy.sh deploy
   ```

3. **Access Cluster**:

   ```bash
   # SSH to first server node
   ssh ansible@<first-server-ip>

   # Use kubectl
   kubectl get nodes
   kubectl get pods -A
   ```

## Deployment Script Commands

- `./deploy.sh deploy` - Full deployment (infrastructure + RKE2)
- `./deploy.sh infra` - Deploy only infrastructure
- `./deploy.sh rke2` - Deploy only RKE2 cluster
- `./deploy.sh status` - Show cluster information
- `./deploy.sh destroy` - Destroy all infrastructure

## Configuration

### Terraform Variables (terraform.tfvars)

```hcl
# Proxmox Configuration
proxmox_api_url = "https://proxmox.example.com:8006/api2/json"
proxmox_node = "proxmox-node1"
proxmox_api_token_id = "root@pam!terraform"
proxmox_api_token_secret = "your-secret-token"

# VM Configuration
template_vm_id = 9000
ssh_public_key = "ssh-rsa AAAAB3NzaC1yc2E..."
vm_username = "ansible"

# Cluster Configuration
rke2_servers = {
  count       = 3
  vm_id_start = 500
  ip_start    = "192.168.3.21"
  cpu_cores   = 2
  memory      = 4096
  disk_size   = 50
}

rke2_agents = {
  count       = 2
  vm_id_start = 550
  ip_start    = "192.168.3.24"
  cpu_cores   = 2
  memory      = 4096
  disk_size   = 50
}

# Network Configuration
network_config = {
  bridge      = "vmbr0"
  subnet      = "192.168.3.0/24"
  subnet_mask = 24
  gateway     = "192.168.3.1"
  vlan_id     = null
}

# RKE2 Cluster Configuration
rke2_config = {
  os               = "linux"
  arch             = "amd64"
  vip              = "192.168.3.50"
  vip_interface    = "eth0"
  metallb_version  = "v0.13.12"
  lb_range         = "192.168.3.80-192.168.3.90"
  lb_pool_name     = "first-pool"
  rke2_version     = "v1.29.4+rke2r1"
  kube_vip_version = "v0.8.0"
}
```

### Ansible Configuration

The Ansible configuration is automatically generated by Terraform but can be customized:

- **Inventory**: `ansible/RKE2/inventory/hosts.ini` (auto-generated)
- **Variables**: `ansible/RKE2/inventory/group_vars/all.yaml` (auto-generated)
- **Playbook**: `ansible/RKE2/site.yaml`

## Cluster Access

### Kubectl Configuration

After deployment, kubeconfig is available at:

- `/etc/rancher/rke2/rke2.yaml` (root access)
- `/home/ansible/.kube/config` (user access on first server)

### Cluster Endpoints

- **API Server**: `https://<vip>:6443`
- **LoadBalancer Services**: IPs from MetalLB range

## Troubleshooting

### Common Issues

1. **VM Template Issues**:

   - Ensure cloud-init is properly configured
   - Verify SSH key is added to template
   - Check network configuration

2. **Network Connectivity**:

   - Verify Proxmox network bridge configuration
   - Check firewall rules
   - Ensure VIP is not conflicting with existing IPs

3. **RKE2 Installation**:
   - Check `/var/log/rke2.log` on cluster nodes
   - Verify systemd service status: `systemctl status rke2-server`
   - Check node resources and disk space

### Log Locations

- **RKE2 Server Logs**: `/var/lib/rancher/rke2/server/logs/`
- **RKE2 Agent Logs**: `/var/lib/rancher/rke2/agent/logs/`
- **System Logs**: `journalctl -u rke2-server` or `journalctl -u rke2-agent`

### Manual Verification

```bash
# Check cluster status
kubectl get nodes -o wide
kubectl get pods -A

# Verify kube-vip
kubectl get pods -n kube-system | grep kube-vip

# Verify MetalLB
kubectl get pods -n metallb-system
kubectl get ipaddresspool -n metallb-system
```

## Customization

### Adding More Nodes

1. Update `terraform.tfvars` to increase node counts
2. Run `terraform apply`
3. Run `./deploy.sh rke2` to configure new nodes

### Changing RKE2 Version

1. Update `rke2_version` in `terraform.tfvars`
2. Run `terraform apply` to update configuration
3. Manually upgrade nodes following RKE2 upgrade procedures

### Custom Manifests

Place custom Kubernetes manifests in:
`ansible/RKE2/roles/apply-manifests/files/`

## Security Considerations

- RKE2 tokens are automatically generated and shared securely
- SSH keys are required for VM access
- Cluster API is secured with TLS certificates
- Network policies can be implemented for pod-to-pod communication

## Maintenance

### Backup

- **etcd**: Automatic snapshots are configured by RKE2
- **Configuration**: Backup `terraform.tfvars` and any custom Ansible files

### Updates

- **OS Updates**: Use Ansible to manage OS updates across nodes
- **RKE2 Updates**: Follow RKE2 upgrade documentation
- **Application Updates**: Use standard Kubernetes deployment practices

## Support

For issues related to:

- **RKE2**: Check [RKE2 Documentation](https://docs.rke2.io/)
- **Terraform Proxmox Provider**: Check [Provider Documentation](https://registry.terraform.io/providers/bpg/proxmox/latest/docs)
- **Ansible**: Check [Ansible Documentation](https://docs.ansible.com/)
